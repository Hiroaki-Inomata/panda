\chapter{MONTSUQIの構造と概念}

\section{プロセス構成}

MONTSUQIは以下のプロセスによって構成される。

\begin{itemize}
\item	{\bf クライアント}	\\
	ユーザのリクエストを受けるプロセスである。現在のところ、glclientを
	クライアントとして利用している
\item	{\bf プレゼンテーションサーバ}	\\
	クライアントと通信を行い、データのやりとりを行うプロセスである
	MONTSUQIサーバの窓口となる。
\item	{\bf ワークフローコントローラ}	\\
	セションとトランザクションの管理を行い、プレゼンテーションサーバと
	アプリケーションサーバ間のルーティングを行う
\item	{\bf アプリケーションサーバ}	\\
	アプリケーションの実行を行う
\item	{\bf データベースサーバ}	\\
	各種データベースマネージャとのインターフェイス、及びデータ保全機能
	の実現を行う
\end{itemize}

\subsection{クライアントとプレゼンテーションサーバ}

MONTSUQIは様々なクライアントに対応するため、MONTSUQIのコアプロセスであるワー
クフローコントローラは、直接クライアントとの通信を行わない。全ての通信
制御はプレゼンテーションサーバが行い、MONTSUQI自身とは独立したものとして
存在する。

この独立性により、他の通信プロトコルに対応するには、別のプレゼンテーショ
ンサーバを記述することにより実現出来る。注意深く記述されたアプリケーショ
ンは、異るプレゼンテーションサーバプロセスであっても正しく動くはずである。

\subsection{ワークフローコントローラ}

MONTSUQIのコアプロセスであり、セションとトランザクションの管理を行い、
プレゼンテーションサーバとアプリケーションサーバ間のデータのルーティン
グを行う。また、分散処理に必要な処理もここで行う。

主な処理は、

\begin{itemize}
\item	{\bf キューの永続化}
\item	{\bf プレゼンテーションサーバとの通信}
\item	{\bf アプリケーションサーバとの通信}
\item	{\bf 他のワークフローコントローラとの通信}
\end{itemize}

キューのメッセージは、大略以下のような項目から構成されている。

\begin{itemize}
\item	{\bf 画面情報}	\\
	画面として表示しているデータ、画面から入力されるデータである
\item	{\bf イベント情報}	\\
	処理の契機となったイベントの情報である
\item	{\bf セション変数}	\\
	当該セションを永続させるためのデータである
\end{itemize}

\subsection{アプリケーションサーバ}

実際の業務を行うプロセスである。キューから1つづつメッセージを読み出し、
1つづつ結果を返す。

1つのアプリケーションサーバは、複数のクライアントからの要求を処理する。
これはセション保持の変数(Scratch Pad Area, SPAと呼ぶ)をワークフローコ
ントローラとの間で受け渡すことによって実現されている。このため、正しく
作られたアプリケーションは、異なるプロセスであっても、同じトランザクショ
ンを処理すれば同じ結果を返すはずである。

アプリケーションサーバは、言語によるデータ形式の違いを吸収するために、言
語毎に異るハンドラが存在している。この言語ハンドラを記述することにより、
別の言語に対応することが出来る。

\subsection{データベースサーバ}

アプリケーションから呼び出され、各種データベースマネージャとのインター
フェイスを行う。またデータの保全を実現も行う。

データベースサーバは、さらに

\begin{itemize}
\item	アプリケーションから呼び出され、インターフェイスになるモジュール
\item	インターフェイスと通信を行い、データ保全を行うモジュール
\end{itemize}

に分けられる。

インターフェイスとなるモジュールは、データベースマネージャとも通信を行
い、実際のデータベースの処理を行う。この部分は、データベースマネージャ
の違いを吸収するためのハンドラがある。このハンドラを作成することにより、
他のデータベースマネージャに対応することも可能である。

データ保全を行うモジュールでは、データベースマネージャへのリクエストを、
ファイルや他のデータベースマネージャにリダイレクトを行う。これにより、
待機している別のホストのデータベースを、アプリケーションの動いているホ
ストのデータベースと連動させたり(レプリケーション)、実行のログを取得し
たりすることが可能になる。

\section{MONTSUQIの理解に必要な概念}

\subsection{概要}

MONTSUQIの動作を理解するためには、以下の概念を理解する必要がある。

\begin{itemize}
\item	{\bf LD}	\\
	業務から見たアプリケーションサーバのことで、トランザクションデータ
	の論理的な宛先(Logical Dentination)となる
\item	{\bf SPA}	\\
	セションに関する全ての変数を保持する領域で、全ての業務に共通な領域
	であるリンケージ領域(LINKAREA)と、同一LD内でのみ有効なSPAAREAとか
	らなる。
\item	{\bf 多重化グループ}	\\
	データの依存性のあるLDを組にしたもの。トランザクションは、この組の
	中では直列に処理されるが、この組同士は並列に処理される
\item	{\bf データベースグループ}	\\
	同じデータベースに保存されるテーブルを組にしたもの。データベースの
	アクセスや保全はこの単位で行われる
\item	{\bf BD}	\\
	バッチプログラムの実行環境について記述した定義体
\item	{\bf ハンドラ}	\\
	「実際の処理」を行うためのモジュール。現在のところ、アプリケーショ
	ンの言語インターフェイスを司る「言語ハンドラ」と、データベースマネー
	ジャとのインターフェイスを司る「データベースハンドラ」が存在する
\end{itemize}

\subsection{LD}

オンラインの業務画面は、全てが独立したものではなく、いくつかの画面が集
まって業務が構成され、その業務の集合体が全体のシステムとなっている。

この業務を構成をする単位の中では、いくつかの画面(を駆動するモジュール)
間では、かなり密にデータの共有が行われる。そこで、そのような画面のまと
まりを単位としてシステム設計を行うと、設計の効率が良くなる。また、デー
タが密に共有されているため、プログラムの実行単位としても効率がいい。こ
のような単位をLDと呼ぶ。

本システムでは、このLDがアプリケーションサーバ(APplication Server,
APS)の実行単位となる。つまり、論理的にはLDとアプリケーションサーバは1
対1に対応する。同じLD内ではSPA(Scratch Pad Area)という領域を共有する。

\subsection{SPA}\label{subsec:SPA}

一般に1つの業務は1回のトランザクションでは終結せず、いくつかのトランザ
クションを組み合わせて行われるものである。このトランザクションの組み合
わせをセションと呼ぶ。トランザクション間でのデータをひきつぎ、セション
を維持するための情報を持っている領域が、このSPAである。

アプリケーションは、この領域にデータを保存することにより、トランザクショ
ンにまたがってデータを保持することが出来る。逆の言い方をすれば、この領
域に保存されないデータは、トランザクション終結後に消失する。

SPA領域は、同一LD内でのみ有効なSPAAREAと、LDをまたがって保持される
LINKAREAとがある。SPAAREAの内容は、別のLDに制御を移した時点で消失する。
LINKAREAについては、セションが終結するまで保持される。

SPAAREA, LINKAREA共に、寿命の範囲でグローバルなデータ領域として参照さ
れる。そのため、アプリケーションモジュール間のデータ交換領域として使用
可能である。このことは言語ハンドラの種類に依らない。

\subsection{並列化}\label{subsec:multiplex}

トランザクションは、発生する順序に従い順次処理が行われるのが基本である。
しかし、データの相互依存性のないトランザクションについては、並列に実行
しても問題は起きないし、そうすることによって実行効率は上がる。本システ
ムでは、3つのレベルを設けて、並列化の指示を行う。

\begin{enumerate}
\item	{\bf no}	\\
	全く並列化を行わないものである。端末から投入されたトランザクション
	は、全て直列に処理される。すなわち、1つの端末からのトランザクショ
	ンが終結後、次のトランザクションが処理させる。この戦略は排他制御上
	の問題は一切発生しないので、デッドロックも起きない。その代わり、処
	理が完全に直列なので、スループットは落ちる
\item	{\bf id}	\\
	データの依存関係のあるLDをまとめてグループ化し、同じグループのトラ
	ンザクションは直列に処理し、異なるグループのトランザクションは並列
	に処理を行うようにする戦略である。この戦略は、データ更新の安全性を
	保ちつつ、処理効率を上げることが可能になる。\\
	このデータの依存関係のあるLDをまとめたものを多重化グループと呼び、
	ワークフローコントローラが実行制御を行う際のヒントとして教えてやる
\item	{\bf ld}	\\
	全てのアプリケーションサーバを並列に稼働させる戦略である。この戦略
	はLD間のデータ依存性がない時に設定可能である。排他制御はデータベー
	スマネージャに全て依存するので、並列に実行されたトランザクション間
	でデッドロックが起きる危険性がある。その代わり、全てのアプリケーショ
	ンサーバが完全に並列に動くので、最もスループットが高い
\end{enumerate}

\subsection{データベースグループ}\label{subsec:DBG}

業務で使うデータテーブルは、単一のデータベースに保存されるとは限らず、
いくつかのデータベースに分散して置かれることも考えられる。また、ログデー
タの発生のしかたによってログファイルを異るファイルに出したいこともある。

このように、データテーブルは、その目的や運用の違いによって、いくつかの
グループに分ける方が、運用の都合上好ましいことが少なくない。そこで、本
システムでは、データテーブルをグループ化して運用が出来るように、データ
ベースグループという概念を持っている。

同じデータベースグループのテーブルは、まとめて同じデータベースマネージャ
にリクエストが出される。また、同じデータベースグループのログデータは、
同じ出口(他のデータベースマネージャやログファイル)に出力される。

\subsection{BD}

バッチプログラムの実行環境について記述した定義体(Batch Description)で
ある。

本来バッチプログラムは、どのように書かれていても実行可能なはずである。
しかし、オンラインシステムの実行メカニズムと矛盾しないように、また同じ
APIでデータベースが操作を行い、またデータ保全が行われるためには、オン
ラインプログラムの実行と同じ管理を行う必要がある。

また、バッチプログラムも、様々な言語によって記述出来るため、そのバッチ
プログラムが、どのような言語で書かれているかを、バッチ用データベースサー
バに教えてやる必要がある。

このような理由から、バッチプログラムもオンラインプログラム同様、本シス
テムの配下で動かせるように、

\subsection{ハンドラ}

本システムのコアモジュールは、本システム内でのデータの操作だけを行い、
実際にアプリケーションを実行したりデータベースをアクセスしたりという処
理は、全て「ハンドラ」と呼ばれるモジュールにまかせている。

具体的には、言語処理系毎に呼び出しや実行のためのシーケンスやインタフェ
イスは異なるが、それらは「言語ハンドラ」と呼ばれるモジュールが、実際の
処理を行っている。本システムを新しい言語に対応させるには、この言語ハン
ドラを書いてやることによって実現される。

データベースマネージャとのインターフェイスも、データベースマネージャ毎
に異るが、これは「データベースハンドラ」が実際の処理を行っている。新し
いデータベースマネージャに対応することは、このデータベースハンドラを書
いてやることによって実現される。


