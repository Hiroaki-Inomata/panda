\chapter{言語ハンドラ作成の手引}

\section{言語ハンドラとは}

言語ハンドラとは、MONTSUQIのアプリケーションサーバが、アプリケーション
を実行する時、言語固有のインターフェイスを吸収する目的で存在する。つま
り、MONTSUQIから見たアプリケーションのインターフェイスを実現するモジュー
ルである。

このモジュールにより、言語固有のデータの扱いや呼び出し手順等を吸収する
ことにより、アプリケーションサーバを多くの言語に対応させ、{\bf 処理に
向いた言語の選択}を容易にする。

\section{言語ハンドラ構造体}

言語ハンドラの構造体は以下のようになっている。

\begin{verbatim}
typedef struct {
    char    *name;
    Bool    fUse;
    void    (*ExecuteProcess)(ProcessNode *);
    void    (*StartBatch)(char *name, char *param);
    /*  DC function */
    void    (*ReadyDC)(void);
    void    (*StopDC)(void);
    void    (*CleanUpDC)(void);
    /*  DB function */
    void    (*ReadyDB)(void);
    void    (*StopDB)(void);
    void    (*CleanUpDB)(void);
}   MessageHandler;
\end{verbatim}

それぞれの値をセットして、アプリケーションサーバ起動時に登録する。メン
バの意味は以下のようになっている。

\begin{itemize}
\item	{\bf name}	\\
	ハンドラの扱う言語の名前を指定する。この名前を{\bf 言語ハンドラ名}
	として、LD定義体やBDのbind定義で参照する
\item	{\bf fUse}	\\
	アプリケーションサーバが起動する時に、その言語ハンドラが実際に使わ
	れているかどうかを調べた結果を入れるフラグ領域。起動時に一旦初期化
	されるので、値は何でも構わない
\item	{\bf ExecuteProcess}	\\
	オンラインプログラムのトランザクション毎にアプリケーションに処理を
	渡すために呼ばれる
\item	{\bf StartBatch}	\\
	バッチ処理を起動する時に呼び出される
\item	{\bf ReadyDC}	\\
	アプリケーションサーバが起動する時に、言語ハンドラ固有の初期化を行
	うために呼び出される。
\item	{\bf StopDC}	\\
	オンラインプログラムを停止する時に呼び出される
\item	{\bf CleanUpDC}	\\
	オンラインプログラム停止後の後始末に呼び出される
\item	{\bf ReadyDB}	\\
	アプリケーションが使うデータベースサブシステムを初期化するために呼
	び出される
\item	{\bf StopDB}	\\
	データベースサブシステムとアプリケーションを切り離すために呼び出さ
	れる
\item	{\bf CleanUpDB}	\\
	アプリケーションサーバ停止後のデータベースサブシステムの後始末に呼
	び出される
\end{itemize}

\subsection{ExecureProcess}

オンラインプログラムがトランザクションを処理するために、実際のアプリケー
ションを呼び出す処理である。

引数は{\tt ProcessNode *}である。この構造体はアプリケーションが実行さ
れるに必要な全ての環境が格納されている。詳細は\ref{sec:ProcessNode}を
参照のこと。

この関数の中での実際の処理は、

\begin{enumerate}
\item	mcprec中のdc.moduleを読み出し、アプリケーションモジュール名を
		得る
\item	アプリケーションモジュールをロードする
\item	アプリケーションを呼び出す
\end{enumerate}

ということになる。

アプリケーションの実行は、トランザクション毎にアイソレートされなくては
ならない。つまり、同じ内容の引数でこの手続きが呼び出された場合、データ
ベースの更新を除いては、常に同じ結果にならなくてはならない。これは、こ
の関数には処理結果に影響を与えるような状態変数はあってはならないことを
意味している。

\subsection{StartBatch}

バッチアプリケーションを起動する時に呼び出される。

引数はアプリケーションモジュール名と、それに渡すべき起動パラメータであ
る。いずれも{\tt char *}のASCIZ文字列である。

この関数の中での実際の処理は、

\begin{enumerate}
\item	アプリケーションモジュールをロードする
\item	アプリケーションを呼び出す
\end{enumerate}

ということになる。また、バッチプログラムの場合、後に述べる
{\tt ReadyDC, StopDC, CleanUpDC}は呼び出されないため、アプリケーション
が動くための環境の準備等も、この中で行わなければならない。

\subsection{ReadyDC}

アプリケーションサーバが起動する時に、言語ハンドラ固有の初期化を行うた
めに呼び出される。

引数はない。

この関数はオプショナルなので、機能として必要のない場合は、何もしなくて
も良く、その時にはNULLにする。

\subsection{StopDC}

アプリケーションサーバが停止する時に、言語ハンドラ固有の終了処理を行う
ために呼び出される。

引数はない。

この関数はオプショナルなので、機能として必要のない場合は、何もしなくて
も良く、その時にはNULLにする。

\subsection{CleanUpDC}

アプリケーションサーバが停止する時に、言語ハンドラ固有の終了処理後の後
処理を行うために呼び出される。

引数はない。

この関数はオプショナルなので、機能として必要のない場合は、何もしなくて
も良く、その時にはNULLにする。

この関数は全ての言語ハンドラの{\tt StopDC}を実行した後に呼び出される。

\subsection{ReadyDB}

アプリケーションサーバが起動する時に、言語ハンドラ固有のデータベースの
初期化を行うために呼び出される。

引数はない。

この関数はオプショナルなので、機能として必要のない場合は、何もしなくて
も良く、その時にはNULLにする。

\subsection{StopDB}

アプリケーションサーバが停止する時に、言語ハンドラ固有のデータベースの
終了処理を行うために呼び出される。

引数はない。

この関数はオプショナルなので、機能として必要のない場合は、何もしなくて
も良く、その時にはNULLにする。

\subsection{CleanUpDB}

アプリケーションサーバが停止する時に、言語ハンドラ固有のデータベース終
了処理後の後処理を行うために呼び出される。

引数はない。

この関数はオプショナルなので、機能として必要のない場合は、何もしなくて
も良く、その時にはNULLにする。

この関数は全ての言語ハンドラの{\tt StopDC}を実行した後に呼び出される。

\section{ProcessNode構造体}

